using Spine.Unity;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;

public interface IHitable
{
    void Hit(float damage);
}

public interface IDeadable
{
    void Dead();
}

// Scripte Desc:
// 플레이어 클래스 입니다.
// 방향 조작으로 인한 움직임과, 데미지를 입었을 때, 죽었을 때 기능합니다.
// 이동 시 변경되는 애니메이션은 Spine 애니메이션을 사용해야 해서 SkeletonAnimation을 이용했습니다.
// 플레이어의 Hp가 0으로 사망한 경우에는 Over Clip을 실행하며 GameOver 창이 활성화 됩니다.

public class Player : Character, IHitable, IDeadable
{
    SkeletonAnimation bone;
    GameObject hpBar;
    Image hpBarSprite;

    public AudioClip deadSound;    // GameOver 효과음
    public GameObject hitEffect;
    public CircleCollider2D magnetismArea;

    private new void Start()
    {
        base.Start();
        bone = GetComponent<SkeletonAnimation>();
        bone.AnimationName = "Idle";
        hpBar = RecordInfoManager.instance.hpBarObj;
        hpBarSprite = hpBar.GetComponent<Image>();
    }

    public override float Hp
    {
        get => base.Hp;
    
        set
        {
            status.hp = value;
            if (status.hp > status.maxHp)
                status.hp = status.maxHp;
            if (status.hp <= status.minHp)
            {
                status.hp = status.minHp;
                Dead();
            }

            float curHp = status.hp;
            float maxHp = status.maxHp;
            // Mathf.Min = A 와 B 중에서 더 작은 값을 반환한다.
            hpBarSprite.fillAmount = curHp / maxHp;
        }
    }

    void Update()
    {
        if (GameManager.instance.IsEnd == false)
        {
            Hp += status.recoveryHp * Time.deltaTime;
        }
    }

    private void FixedUpdate()
    {
        FixedMove();

        if (inputVec.x == 0f && inputVec.y == 0f)
        {
            bone.AnimationName = "Idle";
        }
        else
            bone.AnimationName = "Run";
    }

    public override void Hit(float damage)
    {
        damage = damage * ( 1 / (1+Defense));
        Hp -= damage;
        hitEffect.SetActive(true);
    }

    public override void Dead()
    {
        base.Dead();
        RecordInfoManager.instance.overPopUpWindow.SetActive(true);
        GameManager.instance.IsLive = false;
        SoundManager.instance.Play(deadSound, SoundManager.instance.transform);
    }
}